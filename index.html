<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Door4 - The Knack of AI - Calendar Agent Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body { background:#ffffff; color:#333333; margin:0; padding:32px; display:flex; justify-content:center; }
    .card { width:min(800px, 100%); background:#ffffff; border:1px solid #e0e0e0; border-radius:16px; padding:24px; box-shadow:0 4px 20px rgba(0,0,0,.1); }
    h1 { margin:0 0 8px; font-size:22px; color:#1a1a1a; }
    p.hint { margin:0 0 20px; color:#666666; }
    .grid { display:grid; gap:14px; grid-template-columns:1fr 1fr; }
    .grid .full { grid-column:1 / -1; }
    label { display:block; font-size:12px; color:#666666; margin:0 0 6px; letter-spacing:.02em; font-weight:500; }
    input, textarea, select { width:100%; box-sizing:border-box; background:#ffffff; color:#333333; border:1px solid #d0d0d0; border-radius:8px; padding:10px 12px; outline:none; transition:border-color 0.2s; }
    input:focus, textarea:focus { border-color:#4285f4; box-shadow:0 0 0 3px rgba(66,133,244,.15); }
    .row { display:flex; gap:12px; }
    .btn { cursor:pointer; border:0; border-radius:8px; padding:12px 16px; font-weight:600; transition:all 0.2s; }
    .btn-primary { background:#4285f4; color:#ffffff; }
    .btn-primary:hover { background:#3367d6; }
    .btn-ghost { background:transparent; color:#666666; border:1px solid #d0d0d0; }
    .btn-ghost:hover { background:#f5f5f5; }
    .actions { display:flex; gap:12px; margin-top:12px; align-items:center; }
    .note { font-size:12px; color:#666666; }
    .pill { font-size:11px; color:#137333; background:#e6f4ea; border:1px solid #34a853; padding:4px 8px; border-radius:999px; margin-left:auto; }
    .step { display:none; }
    .step.active { display:block; }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="card">
    <!-- Step 1: Introduction -->
    <div id="step1" class="step active">
      <h1>Calendar Agent Demo. Thank you for taking part!</h1>
      <div style="text-align:center; margin:10px 0;">
        <span style="font-size:12px; color:#999; background:#f5f5f5; padding:4px 8px; border-radius:4px;">v1.0.0</span>
      </div>
      <div style="background:#f8f9fa; border:1px solid #e9ecef; border-radius:8px; padding:20px; margin:20px 0; line-height:1.6;">
        <p style="margin:0 0 16px 0; font-size:16px; color:#495057;">
          This app simply adds a calendar entry into your device calendar. It will invite Leon, and add your mobile number and a couple of details - to test an agent we're building.
        </p>
        <p style="margin:0; font-size:16px; color:#495057;">
          <strong>None of this information is stored, and you'll only receive a message during this test.</strong>
        </p>
      </div>
      <p style="font-size:18px; color:#666; margin:20px 0;">Is that OK?</p>
      <button class="btn btn-primary" onclick="nextStep()">Next</button>
    </div>

    <!-- Step 2: Verb/Activity -->
    <div id="step2" class="step">
      <h1>Great!</h1>
      <p style="font-size:18px; color:#666; margin:20px 0;">Now, give us a "verb" or action... a sport or something you enjoy doing</p>
      <div style="margin:20px 0;">
        <input id="verb" type="text" placeholder="eat / drink / visit / see / run..." style="width:100%; box-sizing:border-box; background:#ffffff; color:#333333; border:1px solid #d0d0d0; border-radius:8px; padding:12px 16px; outline:none; font-size:16px;" />
      </div>
      <button class="btn btn-primary" onclick="nextStep()">Next</button>
    </div>

    <!-- Step 3: Location -->
    <div id="step3" class="step">
      <h1>Perfect!</h1>
      <p style="font-size:18px; color:#666; margin:20px 0;">Where might you do this activity? A place, city, country or a landmark - anything goes. Interesting or boring.</p>
      <div style="margin:20px 0;">
        <input id="location" type="text" placeholder="e.g. Malaga, Spain" style="width:100%; box-sizing:border-box; background:#ffffff; color:#333333; border:1px solid #d0d0d0; border-radius:8px; padding:12px 16px; outline:none; font-size:16px;" />
      </div>
      <button class="btn btn-primary" onclick="nextStep()">Next</button>
    </div>

    <!-- Step 4: Mobile -->
    <div id="step4" class="step">
      <h1>Thanks!</h1>
      <p style="font-size:18px; color:#666; margin:20px 0;">Now just enter your mobile number. (Again, we won't store this)</p>
      <div style="margin:20px 0;">
        <input id="mobile" type="tel" placeholder="+447700900123" style="width:100%; box-sizing:border-box; background:#ffffff; color:#333333; border:1px solid #d0d0d0; border-radius:8px; padding:12px 16px; outline:none; font-size:16px;" />
      </div>
      <button class="btn btn-primary" onclick="nextStep()">Next</button>
    </div>

    <!-- Step 5: Confirmation -->
    <div id="step5" class="step">
      <h1>Great!</h1>
      <div style="background:#e3f2fd; border:1px solid #bbdefb; border-radius:8px; padding:20px; margin:20px 0; line-height:1.6;">
        <p style="margin:0; font-size:16px; color:#1565c0;">
          Now we're going to create an entry in your calendar on <strong>Thursday 9th October</strong>, at <strong id="randomTime">[random time]</strong> - please accept it, don't change the details.
        </p>
      </div>
      <div style="display:flex; gap:12px; margin:20px 0; flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="createEvent()">Create in Google Calendar</button>
        <button class="btn btn-ghost" onclick="downloadICS()">Download .ics (Outlook/Apple)</button>
        <button class="btn btn-ghost" onclick="addToiPhoneCalendar()" id="iphoneBtn" style="display:none;">Add to iPhone Calendar</button>
      </div>
    </div>

    <!-- Hidden inputs for date and time (managed by JavaScript) -->
    <input id="date" type="hidden" />
    <input id="start" type="hidden" />
  </div>

  <script>
    // ðŸ”§ Set this to YOUR address that should be invited
    const MY_EMAIL = "leon.calverley@door4.com";

    // ðŸ”§ Title format for your parser. Use {verb} and {mobile}.
    // Example parses "verb" + "mobile" from the title.
    const TITLE_TEMPLATE = "{verb} :: {mobile}";

    // ðŸ”§ Fixed date configuration - Thursday 09 Oct 2025
    const FIXED_DATE = "2025-10-09";

    function pad(n){ return String(n).padStart(2,'0'); }

    // Formats a local date/time into Google Calendar TEMPLATE range
    // Either all-day (YYYYMMDD/YYYYMMDD) or timed UTC (YYYYMMDDTHHMMSSZ/â€¦)
    function gcalDateRange({ date, start, end, allDay }) {
      const [y, m, d] = date.split('-').map(Number);

      if (allDay) {
        // For all-day, end date is exclusive; add one day
        const startStr = `${y}${pad(m)}${pad(d)}`;
        const endDate = new Date(Date.UTC(y, m - 1, d));
        endDate.setUTCDate(endDate.getUTCDate() + 1);
        const endStr = `${endDate.getUTCFullYear()}${pad(endDate.getUTCMonth()+1)}${pad(endDate.getUTCDate())}`;
        return `${startStr}/${endStr}`;
      }

      const [sh, sm] = start.split(':').map(Number);
      const [eh, em] = end.split(':').map(Number);

      // Construct as local time, then convert to UTC
      const startLocal = new Date(y, m - 1, d, sh, sm || 0, 0);
      const endLocal   = new Date(y, m - 1, d, eh, em || 0, 0);

      const startUTC = new Date(startLocal.getTime() - (startLocal.getTimezoneOffset() * 60000));
      const endUTC   = new Date(endLocal.getTime()   - (endLocal.getTimezoneOffset()   * 60000));

      const fmt = (dt) =>
        dt.getUTCFullYear() +
        pad(dt.getUTCMonth() + 1) +
        pad(dt.getUTCDate()) + "T" +
        pad(dt.getUTCHours()) +
        pad(dt.getUTCMinutes()) +
        pad(dt.getUTCSeconds()) + "Z";

      return `${fmt(startUTC)}/${fmt(endUTC)}`;
    }

    function buildTitle(verb, mobile) {
      return TITLE_TEMPLATE
        .replace("{verb}", verb.trim())
        .replace("{mobile}", mobile.trim());
    }

    function assertTimesValid(start, end, allDay){
      if (allDay) return;
      if (!start || !end) throw new Error("Please set both start and end times.");
      const a = start.split(":").map(Number);
      const b = end.split(":").map(Number);
      const aMin = a[0]*60 + (a[1]||0);
      const bMin = b[0]*60 + (b[1]||0);
      if (bMin <= aMin) throw new Error("End time must be after start time.");
    }

    function handleSubmit(e){
      e.preventDefault();
      try {
        const date     = document.getElementById("date").value;
        const start    = document.getElementById("start").value;
        const end      = calculateEndTime(start);
        const verb     = document.getElementById("verb").value;
        const mobile   = document.getElementById("mobile").value;
        const location = document.getElementById("location").value;
        const notes    = ""; // Notes field removed
        const allDay   = false; // All-day option removed

        if (!date || !verb || !mobile || !location) throw new Error("Please fill date, verb, mobile, and location.");
        assertTimesValid(start, end, allDay);

        const title = buildTitle(verb, mobile);
        const dates = gcalDateRange({ date, start, end, allDay });

        const params = new URLSearchParams({
          action: "TEMPLATE",
          text: title,
          dates,
          location,
          details: notes || ""
        });

        // Add your email as guest; can add multiple &add=value occurrences
        const url = `https://calendar.google.com/calendar/render?${params.toString()}&add=${encodeURIComponent(MY_EMAIL)}`;
        window.open(url, "_blank", "noopener");
      } catch (err) {
        alert(err.message || String(err));
      }
    }

    // Optional: .ics for Outlook/Apple
    function downloadICS(){
      try {
        const date     = document.getElementById("date").value;
        const start    = document.getElementById("start").value;
        const end      = calculateEndTime(start);
        const verb     = document.getElementById("verb").value;
        const mobile   = document.getElementById("mobile").value;
        const location = document.getElementById("location").value;
        const notes    = ""; // Notes field removed
        const allDay   = false; // All-day option removed

        if (!date || !verb || !mobile || !location) throw new Error("Please fill date, verb, mobile, and location.");
        assertTimesValid(start, end, allDay);

        const title = buildTitle(verb, mobile);

        // Build DTSTART/DTEND in UTC or DATE for all-day
        const [y, m, d] = date.split('-').map(Number);
        let dtStart, dtEnd, icsAllDay = false;

        if (allDay) {
          icsAllDay = true;
          const startStr = `${y}${pad(m)}${pad(d)}`;
          const endDate = new Date(Date.UTC(y, m - 1, d));
          endDate.setUTCDate(endDate.getUTCDate() + 1);
          const endStr = `${endDate.getUTCFullYear()}${pad(endDate.getUTCMonth()+1)}${pad(endDate.getUTCDate())}`;
          dtStart = `DTSTART;VALUE=DATE:${startStr}`;
          dtEnd   = `DTEND;VALUE=DATE:${endStr}`;
        } else {
          const dates = gcalDateRange({ date, start, end, allDay:false }).split("/");
          dtStart = `DTSTART:${dates[0]}`;
          dtEnd   = `DTEND:${dates[1]}`;
        }

        const uid = cryptoRandom() + "@agent-demo";
        const ics = [
          "BEGIN:VCALENDAR",
          "VERSION:2.0",
          "PRODID:-//Agent Demo//EN",
          "CALSCALE:GREGORIAN",
          "METHOD:PUBLISH",
          "BEGIN:VEVENT",
          `UID:${uid}`,
          `SUMMARY:${escapeICS(title)}`,
          `${dtStart}`,
          `${dtEnd}`,
          `LOCATION:${escapeICS(location)}`,
          `DESCRIPTION:${escapeICS(notes)}`,
          `ATTENDEE;CN=Demo Host;ROLE=REQ-PARTICIPANT:mailto:${MY_EMAIL}`,
          "END:VEVENT",
          "END:VCALENDAR"
        ].join("\r\n");

        const blob = new Blob([ics], {type: "text/calendar;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "agent-demo-event.ics";
        a.click();
        URL.revokeObjectURL(a.href);
      } catch (err) {
        alert(err.message || String(err));
      }
    }

    function escapeICS(text){
      return (text || "")
        .replace(/\\/g, "\\\\")
        .replace(/\n/g, "\\n")
        .replace(/;/g, "\\;")
        .replace(/,/g, "\\,");
    }

    function cryptoRandom(){
      if (crypto && crypto.getRandomValues) {
        const a = new Uint32Array(4); crypto.getRandomValues(a);
        return Array.from(a).map(x=>x.toString(16)).join("");
      }
      return String(Math.random()).slice(2);
    }

    // Generate random start time in half-hourly intervals (6am to 9pm)
    function generateRandomStartTime() {
      // Generate hours between 6 (6am) and 21 (9pm), inclusive
      const hours = Math.floor(Math.random() * (21 - 6 + 1)) + 6;
      const minutes = Math.random() < 0.5 ? 0 : 30;
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }

    // Calculate end time (1 hour after start time)
    function calculateEndTime(startTime) {
      const [hours, minutes] = startTime.split(':').map(Number);
      const endHours = (hours + 1) % 24;
      return `${endHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }

    // Multi-step functionality
    let currentStep = 1;
    const totalSteps = 5;

    function nextStep() {
      // Validate current step before proceeding
      if (currentStep === 2) {
        const verb = document.getElementById('verb').value.trim();
        if (!verb) {
          alert('Please enter a verb or activity');
          return;
        }
      } else if (currentStep === 3) {
        const location = document.getElementById('location').value.trim();
        if (!location) {
          alert('Please enter a location');
          return;
        }
      } else if (currentStep === 4) {
        const mobile = document.getElementById('mobile').value.trim();
        if (!mobile) {
          alert('Please enter your mobile number');
          return;
        }
      }

      // Hide current step
      document.getElementById(`step${currentStep}`).classList.remove('active');
      
      // Show next step
      currentStep++;
      document.getElementById(`step${currentStep}`).classList.add('active');

      // Auto-focus the input field on the new step
      setTimeout(() => {
        if (currentStep === 2) {
          document.getElementById('verb').focus();
        } else if (currentStep === 3) {
          document.getElementById('location').focus();
        } else if (currentStep === 4) {
          document.getElementById('mobile').focus();
        }
      }, 100); // Small delay to ensure the step is visible

      // If we're on the final step, set the random time
      if (currentStep === 5) {
        const randomTime = generateRandomStartTime();
        document.getElementById('randomTime').textContent = randomTime;
        document.getElementById('date').value = FIXED_DATE;
        document.getElementById('start').value = randomTime;
        
        // Show iPhone button if on iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if (isIOS) {
          document.getElementById('iphoneBtn').style.display = 'inline-block';
        }
      }
    }

    function createEvent() {
      // Use the existing handleSubmit logic but without the form submission
      try {
        const date = document.getElementById("date").value;
        const start = document.getElementById("start").value;
        const end = calculateEndTime(start);
        const verb = document.getElementById("verb").value;
        const mobile = document.getElementById("mobile").value;
        const location = document.getElementById("location").value;
        const notes = ""; // Notes field removed
        const allDay = false; // All-day option removed

        if (!date || !verb || !mobile || !location) throw new Error("Please fill all required fields.");
        assertTimesValid(start, end, allDay);

        const title = buildTitle(verb, mobile);
        const dates = gcalDateRange({ date, start, end, allDay });

        // Check if user is on iPhone/iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        if (isIOS) {
          // On iOS, use ICS download instead of Google Calendar template
          downloadICS();
        } else {
          // On other devices, use Google Calendar template
          const params = new URLSearchParams({
            action: "TEMPLATE",
            text: title,
            dates,
            location,
            details: notes || ""
          });

          // Add your email as guest; can add multiple &add=value occurrences
          const url = `https://calendar.google.com/calendar/render?${params.toString()}&add=${encodeURIComponent(MY_EMAIL)}`;
          window.open(url, "_blank", "noopener");
        }
      } catch (err) {
        alert(err.message || String(err));
      }
    }

    function addToiPhoneCalendar() {
      try {
        const date = document.getElementById("date").value;
        const start = document.getElementById("start").value;
        const end = calculateEndTime(start);
        const verb = document.getElementById("verb").value;
        const mobile = document.getElementById("mobile").value;
        const location = document.getElementById("location").value;
        const notes = ""; // Notes field removed

        if (!date || !verb || !mobile || !location) throw new Error("Please fill all required fields.");

        const title = buildTitle(verb, mobile);
        
        // Format date and time for calendar URL
        const [year, month, day] = date.split('-').map(Number);
        const [startHour, startMin] = start.split(':').map(Number);
        const [endHour, endMin] = end.split(':').map(Number);
        
        // Create Date objects for start and end times
        const startDate = new Date(year, month - 1, day, startHour, startMin);
        const endDate = new Date(year, month - 1, day, endHour, endMin);
        
        // Format dates for calendar URL (ISO format)
        const startISO = startDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        const endISO = endDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        
        // Create ICS content for single event (not subscription)
        const icsContent = [
          'BEGIN:VCALENDAR',
          'VERSION:2.0',
          'PRODID:-//Door4//Calendar Agent Demo//EN',
          'CALSCALE:GREGORIAN',
          'METHOD:PUBLISH',
          'BEGIN:VEVENT',
          `UID:${cryptoRandom()}@door4-demo`,
          `SUMMARY:${title}`,
          `DTSTART:${startISO}`,
          `DTEND:${endISO}`,
          `LOCATION:${location}`,
          `DESCRIPTION:${notes}`,
          `ATTENDEE;CN=Leon Calverley;ROLE=REQ-PARTICIPANT:mailto:${MY_EMAIL}`,
          'STATUS:CONFIRMED',
          'TRANSP:OPAQUE',
          'END:VEVENT',
          'END:VCALENDAR'
        ].join('\r\n');
        
        // Create blob and download link that works on iOS
        const blob = new Blob([icsContent], {type: "text/calendar;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        
        // Create a temporary link and trigger download
        const link = document.createElement('a');
        link.href = url;
        link.download = 'door4-calendar-event.ics';
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Clean up the URL object
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        
      } catch (err) {
        // Fallback to regular ICS download if this method fails
        downloadICS();
      }
    }

    // Initialize form when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Set up the multi-step interface
      currentStep = 1;
    });
  </script>
</body>
</html>
